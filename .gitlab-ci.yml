# GitLab CI configuration for rolypoly
# Tests installation only on tagged releases to main branch

stages:
  - test-installation

variables:
  DEBIAN_FRONTEND: noninteractive

# Test installation using quick_setup.sh (recommended method)
test-mamba-installation:
  stage: test-installation
  image: python:3.9-slim
  rules:
    # Run on main branch with a release tags
    - if: $CI_COMMIT_REF_NAME == "main" && $CI_COMMIT_TAG
  before_script:
    # Update package lists and install basic dependencies
    - echo $CI_COMMIT_TAG
    - apt-get update -qq
    - apt-get install -y -qq wget curl git build-essential
    
  script:
    # Test PyPI installation (recommended method)
    - curl -O https://code.jgi.doe.gov/rolypoly/rolypoly/-/raw/main/src/setup/quick_setup.sh
    - bash quick_setup.sh 

  after_script:
    - echo "Installation test completed for commit $CI_COMMIT_SHA on branch $CI_COMMIT_REF_NAME with tag $CI_COMMIT_TAG"
    - ./rolypoly/env/bin/rolypoly --version
